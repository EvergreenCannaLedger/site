---
title: "Washington Cannabis Dashboards" 
subtitle: "The Appreciation of Licensees Adopting CCRS Reporting"
format:
  html:
    theme: flatly
    toc: true
    embed-resources: false
    allow-html: true
execute:
  echo: false
  warning: false
  message: false
---

## Number of Licensees (2021-2025)

```{r, echo=FALSE, include=FALSE}

library(tidyverse)
library(DBI)
library(dplyr)
library(lubridate)
library(plotly)
library(arrow)
library(duckdb)
library(fs)
library(glue)
library(kableExtra)
library(scales)
library(DT)

#Clean Slate Function
if (exists("con")) 
  try(DBI::dbDisconnect(con), silent = TRUE)

source("R_scripts/connect_duckdb_readonly.R")

# Monthly Sales
monthly_sales <- dbGetQuery(con, "
WITH base AS (
SELECT
sh.LicenseeId,
DATE_TRUNC('month', CAST(sh.SaleDate AS DATE)) AS Month,
CAST(sd.Quantity AS DOUBLE) * CAST(sd.UnitPrice AS DOUBLE) +
CAST(sd.SalesTax AS DOUBLE) + CAST(sd.OtherTax AS DOUBLE) AS Revenue
FROM SalesDetail_all sd
JOIN SaleHeader_all sh ON sd.SaleHeaderId = sh.SaleHeaderId
WHERE DATE(CAST(sh.SaleDate AS DATE)) BETWEEN '2021-12-01' AND '2025-12-03'
AND CAST(sd.UnitPrice AS DOUBLE) < 200
),
grouped AS (
SELECT
Month,
LicenseeId,
SUM(Revenue) AS TotalRevenue
FROM base
GROUP BY Month, LicenseeId
),
licensee_counts AS (
SELECT
Month,
COUNT(DISTINCT LicenseeId) AS LicenseeCount
FROM grouped
GROUP BY Month
ORDER BY Month
)
SELECT * FROM licensee_counts
")

```

**Monthly Licensee Participation**

```{r}
# Convert Month to date type

monthly_sales <- monthly_sales %>%
mutate(Month = as.Date(Month))

# Plotly bar chart
plot_ly(
data = monthly_sales,
x = ~Month,
y = ~LicenseeCount,
type = "bar",
marker = list(color = "#2C7BB6")
) %>%
layout(
title = "Number of Licensees Reporting Monthly (Dec 2021 - DEC 2025)",
xaxis = list(title = "Month"),
yaxis = list(title = "Licensee Count"),
hovermode = "x unified"
)

```

## Product Category Growth Over Time
**Double click on a name in legend to isolate that field**
**Double click again to reset and view all, repeat**
```{r}

product_growth <- dbGetQuery(con, "
SELECT
DATE_TRUNC('month', CAST(sh.SaleDate AS DATE)) AS Month,
p.InventoryType,
SUM(CAST(sd.Quantity AS DOUBLE)) AS UnitsSold
FROM SalesDetail_all sd
JOIN SaleHeader_all sh ON sd.SaleHeaderId = sh.SaleHeaderId
JOIN Inventory_all i ON sd.InventoryId = i.InventoryId
JOIN Product_all p ON i.ProductId = p.ProductId
WHERE sh.SaleDate IS NOT NULL
GROUP BY Month, p.InventoryType
ORDER BY Month
")
```

```{r}

product_growth <- product_growth %>% mutate(Month = as.Date(Month))

plot_ly(
data = product_growth,
x = ~Month,
y = ~UnitsSold,
color = ~InventoryType,
type = 'scatter',
mode = 'lines+markers'
) %>%
layout(
title = "Product Category Growth Over Time",
xaxis = list(title = "Month"),
yaxis = list(title = "Units Sold"),
legend = list(orientation = 'h', x = 0.1, y = -0.2)
)

```

## Total Revenue

```{r, include=FALSE}

retail_wholesale <- dbGetQuery(con, "
  SELECT 
    DATE_TRUNC('month', CAST(sh.SaleDate AS DATE)) AS Month,
    sh.SaleType,
    SUM(CAST(sd.Quantity AS DOUBLE) * CAST(sd.UnitPrice AS DOUBLE)) AS Revenue
  FROM SalesDetail_all sd
  JOIN SaleHeader_all sh ON sd.SaleHeaderId = sh.SaleHeaderId
  WHERE sh.SaleType IN ('Retail', 'Wholesale')
  GROUP BY Month, sh.SaleType
  ORDER BY Month
")


```

```{r}

retail_wholesale <- retail_wholesale %>% mutate(Month = as.Date(Month))

plot_ly(retail_wholesale, x = ~Month, y = ~Revenue, color = ~SaleType, type = "bar") %>%
  layout(
    barmode = "group",
    title = "Total Reported Revenue",
    xaxis = list(title = "Month"),
    yaxis = list(title = "Revenue ($)", tickformat = "$,.0f"),
    legend = list(title = list(text = "Sale Type")),
    hovermode = "x unified"
  )

```

## Regional or Business-Level Insights (City Location)

```{r, include=FALSE}

regional_sales <- dbGetQuery(con, "
SELECT
l.City,
SUM(CAST(sd.Quantity AS DOUBLE) * CAST(sd.UnitPrice AS DOUBLE)) AS Revenue
FROM SalesDetail_all sd
JOIN SaleHeader_all sh ON sd.SaleHeaderId = sh.SaleHeaderId
JOIN Licensee_all l ON sh.LicenseeId = l.LicenseeId
WHERE sh.SaleDate IS NOT NULL AND l.City IS NOT NULL
GROUP BY l.City
ORDER BY Revenue DESC
LIMIT 10
")

```

```{r}
plot_ly(
  data = regional_sales,
  x = ~reorder(City, Revenue),  # Fixed the reorder logic
  y = ~Revenue,
  type = 'bar',
  orientation = 'v',
  marker = list(color = "darkgreen")
) %>%
layout(
  title = "Top Business Licensee Cities by Revenue",
  xaxis = list(title = "City"),
  yaxis = list(
    title = "Revenue",
    tickformat = "$,.2f"  # Dollar formatting
  ),
  margin = list(b = 100)
)

```
## Product Category Trends (2021â€“2024)
```{r, warning=FALSE}

# Query category-level trends
category_summary <- dbGetQuery(con, "
  WITH sales_base AS (
    SELECT 
      sd.SaleDetailId,
      sh.SaleDate,
      pr.InventoryType,
      CAST(sd.Quantity AS DOUBLE) AS Quantity,
      CAST(sd.UnitPrice AS DOUBLE) AS UnitPrice,
      CAST(sd.Discount AS DOUBLE) AS Discount
    FROM SalesDetail_all sd
    JOIN SaleHeader_all sh ON sd.SaleHeaderId = sh.SaleHeaderId
    JOIN Inventory_all inv ON sd.InventoryId = inv.InventoryId
    JOIN Product_all pr ON inv.ProductId = pr.ProductId
    WHERE (sd.IsDeleted IS NULL OR sd.IsDeleted NOT IN ('TRUE', 'true'))
      AND (sh.IsDeleted IS NULL OR sh.IsDeleted NOT IN ('TRUE', 'true'))
      AND (inv.IsDeleted IS NULL OR inv.IsDeleted NOT IN ('TRUE', 'true'))
      AND (pr.IsDeleted IS NULL OR pr.IsDeleted NOT IN ('TRUE', 'true'))
      AND CAST(sd.UnitPrice AS DOUBLE) < 200
  )

  SELECT 
    EXTRACT(YEAR FROM DATE(SaleDate)) AS Year,
    InventoryType,
    SUM(Quantity) AS UnitsSold,
    ROUND(SUM(Quantity * UnitPrice), 2) AS Revenue,
    ROUND(AVG(UnitPrice), 2) AS AvgUnitPrice,
    ROUND(MEDIAN(UnitPrice), 2) AS MedianUnitPrice
  FROM sales_base
  GROUP BY 1, 2
  ORDER BY Year, Revenue DESC
")

# Format for publication
category_summary %>%
  filter(
    !InventoryType %in% c(
      "Flower Unlotted", "Other Material Lot", "Other Material Unlotted",
      "Plant", "Sample Jar", "Seed", "Waste"
    )
  ) %>%
  mutate(
    Revenue = dollar(Revenue),
    AvgUnitPrice = dollar(AvgUnitPrice),
    MedianUnitPrice = dollar(MedianUnitPrice),
    UnitsSold = comma(UnitsSold)
  ) %>%
  rename(
    Year = Year,
    Category = InventoryType,
    `Units Sold` = UnitsSold,
    `Total Revenue` = Revenue,
    `Avg. Unit Price` = AvgUnitPrice,
    `Median Unit Price` = MedianUnitPrice
  ) %>%
  arrange(Category, Year) %>%
  datatable(
    caption = htmltools::tags$caption(
      style = 'caption-side: bottom; text-align: left;',
      'Product Category Trends (2021â€“2024)'
    ),
    filter = "top",          # ðŸ‘ˆ adds column filters
    rownames = FALSE,
    options = list(
      pageLength = 20,       # ðŸ‘ˆ show 20 rows at a time
      lengthMenu = c(10, 20, 50, 100),
      autoWidth = TRUE,
      dom = "lfrtip"         # length, filter, table, pagination
    )
  )
```

<br>

:::{.text-center}
[Make a dashboard request you want to see live in this Dashboard page.](mailto:tecl@evergreencannaledger.org)
:::